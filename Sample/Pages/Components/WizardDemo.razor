
@page "/pggm-wizard"
@inject IJSRuntime JSRuntime

<PageTitle>PGGM Wizard</PageTitle>

<PggmHeader Level="1">PGGM Wizard</PggmHeader>

<PggmWizard @ref="wizardRef" Method="POST" Action="/api/submit-wizard"
    OnBeforeNavigate="HandleBeforeNavigate" OnBeforeSubmit="HandleBeforeSubmit"
    OnWizardFinished="HandleWizardFinished">

    <ChildContent>
        <PggmWizardForm Label="Personal Information" Active="true">
            <form>
                <PggmHeader Level="3">Enter Your Personal Information</PggmHeader>
                <p>Please fill in your personal information.</p>
                <PggmFieldset>
                    <Label>
                        <PggmLabel For="firstName">First Name *</PggmLabel>
                    </Label>
                    <Description>
                        <p>Vul uw naam in.</p>
                    </Description>
                    <Error>
                        <PggmErrorMessage For="firstName" Validity="@PggmErrorMessage.ValidityStates.ValueMissing">
                            First name is required
                        </PggmErrorMessage>
                    </Error>
                    <ChildContent>
                        <PggmInput Id="firstName" Name="firstName" Required="true" @bind-value="@firstName" />
                    </ChildContent>

                </PggmFieldset>
                <PggmFieldset>
                    <Label>
                        <PggmLabel For="lastName">Last Name *</PggmLabel>
                    </Label>
                    <Description>
                        <p>Vul uw achternaam in.</p>
                    </Description>
                    <Error>
                        <PggmErrorMessage For="lastName" Validity="@PggmErrorMessage.ValidityStates.ValueMissing">
                            Last name is required
                        </PggmErrorMessage>
                    </Error>
                    <ChildContent>
                        <PggmInput Id="lastName" Name="lastName" Required="true" @bind-value="@lastName" />
                    </ChildContent>
                </PggmFieldset>
                <PggmFieldset>
                    <Label>
                        <PggmLabel For="email">Email *</PggmLabel>
                    </Label>
                    <Description>
                        <p>Vul uw email in.</p>
                    </Description>
                    <Error>
                        <PggmErrorMessage For="email" Validity="@PggmErrorMessage.ValidityStates.ValueMissing">
                            Email is required
                        </PggmErrorMessage>
                        <PggmErrorMessage For="email" Validity="@PggmErrorMessage.ValidityStates.TypeMismatch">
                            Please enter a valid email address
                        </PggmErrorMessage>
                    </Error>
                    <ChildContent>
                        <PggmInput Id="email" Name="email" Type="@PggmInput.InputTypes.Email" Required="true"
                            @bind-Value="@email" />
                    </ChildContent>
                </PggmFieldset>
            </form>
        </PggmWizardForm>

        <PggmWizardForm Label="Additional Info" NextDisabled="@(!allowNextStep)">
            <form>
                <PggmHeader Level="3">Additional Information</PggmHeader>
                <p>Provide any additional information you think is relevant.</p>
                <PggmFieldset>
                    <Label>
                        <PggmLabel For="phoneInput">Phone Number</PggmLabel>
                    </Label>
                    <ChildContent>
                        <PggmInputPhone id="phoneInput" @bind-Value="@phoneNumber" TopCountries="NL,BE,DE,FR"
                            CountryLabel="Choose country..." InitialCountry="NL" Name="phone" />
                    </ChildContent>
                </PggmFieldset>

                <PggmFieldset>
                    <PggmCheckbox Id="subscribe" Name="allowNavigation" @bind-Checked="allowNavigation">
                        Allow navigation to next step (via event cancellation)
                    </PggmCheckbox>
                </PggmFieldset>

                <PggmFieldset>
                    <PggmCheckbox Id="allowNextStep" Name="allowNextStep" @bind-Checked="allowNextStep">
                        Allow navigation to next step (via disable Next button)
                    </PggmCheckbox>
                </PggmFieldset>

            </form>
        </PggmWizardForm>

        <PggmWizardForm Label="Confirmation">
            <form>
                <PggmHeader Level="3">Review Your Information</PggmHeader>
                <p>Please review and confirm your information.</p>

                <ul is="pggm-unordered-list">
                    <li>First Name: @firstName</li>
                    <li>Last Name: @lastName</li>
                    <li>Email: @email</li>
                    <li>Phone Number: @(string.IsNullOrWhiteSpace(phoneNumber) ? "N/A" : phoneNumber)</li>
                </ul>
                <PggmFieldset>
                    <Error>
                        <PggmErrorMessage For="terms" Validity="@PggmErrorMessage.ValidityStates.ValueMissing">
                            You must agree to the terms and conditions
                        </PggmErrorMessage>
                    </Error>
                    <ChildContent>
                        <PggmCheckbox Id="terms" Name="terms" Required="true">
                            I agree to the terms and conditions
                        </PggmCheckbox>
                    </ChildContent>
                </PggmFieldset>

            </form>
        </PggmWizardForm>
    </ChildContent>

    <FinishContent>
        <p>Thank you for submitting your information!</p>
    </FinishContent>

    <ErrorContent>
        <p>There was an error. Please try again.</p>
    </ErrorContent>
</PggmWizard>

@code {
    private bool allowNavigation = true;
    private bool allowNextStep = true;
    private PggmWizard? wizardRef;

    // Form field properties for binding
    private string? firstName;
    private string? lastName;
    private string? email;
    private string? phoneNumber;

    private Task HandleBeforeNavigate(Pggm.Components.Models.Wizard.BeforeNavigateEventArgs args)
    {
        // Check cancellation logic
        if (args?.Direction == "forwards" && !allowNavigation)
        {
            args.Cancel = true;
        }

        return Task.CompletedTask;
    }

    private async Task HandleBeforeSubmit(Pggm.Components.Models.Wizard.BeforeSubmitEventArgs args)
    {
        // Always cancel the default submit behavior
        args.Cancel = true;

        // Show confirmation dialog
        var confirmed = await ShowConfirmationDialog();

        // Call finish on the wizard with the user's choice
        if (wizardRef != null)
        {
            await wizardRef.FinishAsync(confirmed);
        }
    }

    private async Task<bool> ShowConfirmationDialog()
    {
        // Use JavaScript confirm dialog for simplicity
        // In a real application, you might want to use a custom modal component
        return await JSRuntime.InvokeAsync<bool>("confirm",
        "Are you sure you want to submit this form?\n\n" +
        $"First Name: {firstName}\n" +
        $"Last Name: {lastName}\n" +
        $"Email: {email}\n" +
        $"Phone: {phoneNumber ?? "N/A"}\n\n" +
        "Click OK to submit or Cancel to abort.");
    }

    private Task HandleWizardFinished()
    {
        StateHasChanged();
        return Task.CompletedTask;
    }
}
